<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Boutique</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="header">
    <div class="container">
      <h1>Administration de la Boutique</h1>
      <a href="boutique.html" class="btn">Voir la Boutique</a>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <h2>Ajouter / Modifier un Produit</h2>
      <form id="form">
        <label>Image :
          <input type="file" id="image" accept="image/*">
        </label>
        <img id="preview" style="display:none;max-width:120px;margin:10px 0;border-radius:8px;">

        <label>Titre :
          <input type="text" id="titre" required>
        </label>

        <label>Prix (MAD) :
          <input type="number" id="prix" required>
        </label>

        <label>Catégorie :
          <input type="text" id="categorie">
        </label>

        <label>SKU / Référence :
          <input type="text" id="sku">
        </label>

        <label>Description :
          <textarea id="description"></textarea>
        </label>

        <input type="hidden" id="product-id">

        <div class="actions">
          <button type="submit" class="btn primary">Enregistrer</button>
          <button type="button" id="reset" class="btn">Vider</button>
          <button type="button" id="delete" class="btn danger" disabled>Supprimer</button>
        </div>
      </form>
    </section>

    <section class="card">
      <h2>Produits enregistrés</h2>
      <input type="text" id="search" placeholder="Rechercher un produit..." style="width:100%;padding:10px;margin-bottom:10px;">
      <div id="list" class="grid"></div>
      <p id="empty" style="display:none;">Aucun produit trouvé.</p>
    </section>
  </main>

  <footer>
    © 2025 Aymane Ali Shop
  </footer>

  <script src="app.js"></script>
  <script>
    const form = document.getElementById('form');
    const list = document.getElementById('list');
    const preview = document.getElementById('preview');
    const imgInput = document.getElementById('image');
    const inputId = document.getElementById('product-id');
    const btnDelete = document.getElementById('delete');
    const search = document.getElementById('search');
    let PRODUCTS = [];

    imgInput.addEventListener('change', () => {
      const file = imgInput.files[0];
      if (!file) { preview.style.display = 'none'; return; }
      const reader = new FileReader();
      reader.onload = e => { preview.src = e.target.result; preview.style.display = 'block'; };
      reader.readAsDataURL(file);
    });

    async function refresh() {
      PRODUCTS = await apiGetProducts();
      render(PRODUCTS, search.value);
    }

    function render(data, q = '') {
      list.innerHTML = '';
      const filt = data.filter(p =>
        (p.titre + ' ' + (p.description || '')).toLowerCase().includes(q.toLowerCase())
      );
      if (!filt.length) {
        document.getElementById('empty').style.display = 'block';
        return;
      }
      document.getElementById('empty').style.display = 'none';
      for (const p of filt) {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img src="${p.image || ''}" class="thumb" alt="">
          <h3>${p.titre}</h3>
          <p><b>${p.prix} MAD</b> • ${p.categorie || ''}</p>
          <p>${p.description || ''}</p>
          <div class="row">
            <button class="btn" data-edit="${p.id}">Modifier</button>
            <button class="btn danger" data-del="${p.id}" data-row="${p.__row}">Supprimer</button>
          </div>
        `;
        list.appendChild(card);
      }
    }

    search.addEventListener('input', () => render(PRODUCTS, search.value));

    list.addEventListener('click', async (e) => {
      const editId = e.target.getAttribute('data-edit');
      const delId = e.target.getAttribute('data-del');
      const delRow = e.target.getAttribute('data-row');

      if (editId) {
        const p = PRODUCTS.find(x => String(x.id) === String(editId));
        if (!p) return;
        document.getElementById('titre').value = p.titre || '';
        document.getElementById('prix').value = p.prix || '';
        document.getElementById('categorie').value = p.categorie || '';
        document.getElementById('sku').value = p.sku || '';
        document.getElementById('description').value = p.description || '';
        inputId.value = p.id;
        btnDelete.disabled = false;
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      if (delId || delRow) {
        if (!confirm('Supprimer ce produit ?')) return;
        try {
          await apiDeleteProduct(delId, delRow);
          await refresh();
          form.reset(); inputId.value = ''; btnDelete.disabled = true;
          alert('Produit supprimé avec succès.');
        } catch (err) {
          alert('Erreur lors de la suppression.');
        }
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const titre = document.getElementById('titre').value.trim();
      const prix = document.getElementById('prix').value.trim();
      if (!titre || !prix) return alert('Titre et prix sont obligatoires.');

      const id = inputId.value || Date.now().toString();
      const imageFile = imgInput.files[0];
      let image64 = null;
      if (imageFile) image64 = await fileToBase64(imageFile);

      const record = {
        id,
        titre,
        prix,
        categorie: document.getElementById('categorie').value,
        sku: document.getElementById('sku').value,
        description: document.getElementById('description').value,
      };
      if (image64) record.image = image64;

      await apiUpsertProduct(record);
      await refresh();
      form.reset(); inputId.value = ''; btnDelete.disabled = true;
      preview.style.display = 'none';
      alert('Produit enregistré avec succès.');
    });

    document.getElementById('reset').addEventListener('click', () => {
      form.reset(); inputId.value = ''; btnDelete.disabled = true; preview.style.display = 'none';
    });

    refresh();
  </script>
</body>
</html>
