<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Boutique</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="header">
    <div class="container header-inner">
      <h1>Admin Boutique</h1>
      <nav>
        <a class="btn" href="boutique.html">Voir la boutique</a>
      </nav>
    </div>
  </div>

  <div class="container" style="display:grid; gap:14px;">
    <section class="card">
      <h2>Ajouter / Modifier un produit</h2>
      <form id="form" class="grid" novalidate>
        <div class="field">
          <label>Image</label>
          <input type="file" id="image" accept="image/*">
          <img id="image-preview" class="thumb" style="display:none; margin-top:8px;">
        </div>
        <div class="field">
          <label>Titre</label>
          <input type="text" id="titre" required>
        </div>
        <div class="row">
          <div class="field" style="flex:1 1 180px;">
            <label>Prix (MAD)</label>
            <input type="number" id="prix" required>
          </div>
          <div class="field" style="flex:1 1 180px;">
            <label>Catégorie</label>
            <input type="text" id="categorie">
          </div>
        </div>
        <div class="field">
          <label>SKU / Référence</label>
          <input type="text" id="sku">
        </div>
        <div class="field">
          <label>Description</label>
          <textarea id="description"></textarea>
        </div>
        <input type="hidden" id="product-id">
        <div class="row">
          <button type="button" class="btn" id="reset">Vider</button>
          <button type="button" class="btn danger" id="delete" disabled>Supprimer</button>
          <button type="submit" class="btn primary">Enregistrer</button>
        </div>
      </form>
    </section>

    <section class="card">
      <h2>Inventaire</h2>
      <input id="q" placeholder="Recherche..." style="margin-bottom:10px;width:100%;padding:10px;">
      <div id="list" class="grid"></div>
      <div id="empty" class="empty" style="display:none;">Aucun produit.</div>
    </section>
  </div>

  <footer>© 2025 Aymane Ali Shop</footer>

  <script src="app.js"></script>
  <script>
    const el = (id) => document.getElementById(id);
    const form = el('form');
    const list = el('list');
    const q = el('q');
    const btnDel = el('delete');
    const inputId = el('product-id');
    const imgInput = el('image');
    const imgPrev = el('image-preview');
    let PRODUCTS = [];

    imgInput.addEventListener('change', () => {
      const f = imgInput.files[0];
      if (!f) { imgPrev.style.display='none'; return; }
      const r = new FileReader();
      r.onload = () => { imgPrev.src=r.result; imgPrev.style.display='block'; };
      r.readAsDataURL(f);
    });

    function render(data, qv='') {
      list.innerHTML = '';
      const filt = data.filter(p => (p.titre + ' ' + (p.description||'') + ' ' + (p.categorie||'')).toLowerCase().includes(qv.toLowerCase()));
      if (!filt.length) { el('empty').style.display='block'; return; }
      el('empty').style.display='none';
      for (const p of filt) {
        const card=document.createElement('div');
        card.className='card';
        card.innerHTML = `
          <img class="thumb" src="${p.image}" alt="">
          <h3>${p.titre}</h3>
          <p><strong>${p.prix} MAD</strong> • ${p.categorie||''}</p>
          <p>${p.description||''}</p>
          <div class="row">
            <button class="btn" data-edit="${p.id}">Modifier</button>
            <button class="btn danger" data-del="${p.id}" data-row="${p.__row}">Supprimer</button>
          </div>`;
        list.appendChild(card);
      }
    }

    async function refresh(){
      PRODUCTS = await apiGetProducts();
      render(PRODUCTS, q.value||'');
    }

    q.addEventListener('input', ()=>render(PRODUCTS,q.value||''));

    list.addEventListener('click', async e=>{
      const editId = e.target.getAttribute('data-edit');
      const delId = e.target.getAttribute('data-del');
      const delRow = e.target.getAttribute('data-row');
      if (editId){
        const p = PRODUCTS.find(x=>String(x.id)===String(editId));
        if(!p) return;
        inputId.value=p.id;
        el('titre').value=p.titre||'';
        el('prix').value=p.prix||'';
        el('categorie').value=p.categorie||'';
        el('sku').value=p.sku||'';
        el('description').value=p.description||'';
        btnDel.disabled=false;
        window.scrollTo({top:0,behavior:'smooth'});
      }else if (delId || delRow){
        if(!confirm('Supprimer ce produit ?')) return;
        try{
          await apiDeleteProduct(delId, delRow);
          await refresh();
          form.reset(); inputId.value=''; btnDel.disabled=true;
          alert('Produit supprimé.');
        }catch{ alert('Erreur suppression.'); }
      }
    });

    el('reset').addEventListener('click', ()=>{ form.reset(); inputId.value=''; btnDel.disabled=true; });

    form.addEventListener('submit', async e=>{
      e.preventDefault();
      const id = inputId.value || Date.now().toString();
      const titre = el('titre').value.trim();
      const prix = el('prix').value.trim();
      if(!titre||!prix) return alert('Titre et prix obligatoires');
      const f = imgInput.files[0];
      let image64=null;
      if(f) image64=await fileToBase64(f);
      const payload={ id,titre,prix,categorie:el('categorie').value,sku:el('sku').value,description:el('description').value };
      if(image64) payload.image=image64;
      await apiUpsertProduct(payload);
      await refresh();
      form.reset(); inputId.value=''; btnDel.disabled=true; imgPrev.style.display='none';
      alert('Produit enregistré.');
    });

    refresh();
  </script>
</body>
</html>

